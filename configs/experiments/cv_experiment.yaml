# configs/experiments/cv_experiment.yaml
# 5-Fold Cross-Validation 實驗配置 (獨立配置，不使用繼承)

# ==========================================
# 實驗資訊
# ==========================================
experiment:
  name: "cv_baseline"
  version: "v2.1"
  tags: ["5-fold-cv", "siglip2-base", "hash-64", "knn-20"]
  notes: "5-Fold Cross-Validation with optimized parameters"
  seed: 42
  deterministic: false

# ==========================================
# K-Fold 配置
# ==========================================
k_fold:
  enabled: true
  num_folds: 5
  current_fold: 0  # 會被 run_5fold_cv.sh 覆寫

# 路徑配置
paths:
  data_root: "data/coco"
  output_dir: "experiments/outputs"
  checkpoint_dir: "experiments/checkpoints"

# ==========================================
# 模型配置
# ==========================================
model:
  siglip2_variant: "google/siglip2-base-patch16-256"
  max_num_patches: 256
  text_max_length: 64
  freeze_towers: true
  
  decomposer:
    eps: 1.0e-6
  
  fusion:
    type: "hadamard_with_magnitude"
    mlp_dims: [1024, 512]
    dropout: 0.1
    activation: "relu"
  
  hash:
    bits: 64
    activation: "tanh"
  
  classifier:
    num_classes: 80
    use_bias: true

# ==========================================
# 損失函數
# ==========================================
loss:
  bce_weight: 1.0
  use_focal_loss: false
  focal_alpha: 0.25
  focal_gamma: 2.0
  cosine_weight: 1.0
  hash_weight: 0.1
  hash_reg:
    lambda_balance: 0.1
    lambda_decorr: 0.01

# ==========================================
# 訓練配置（CV 優化）
# ==========================================
training:
  batch_size: 32
  gradient_accumulation_steps: 2
  effective_batch_size: 64
  num_epochs: 20
  warmup_epochs: 1
  val_every_n_epochs: 1
  gradient_clip_norm: 1.0
  max_grad_norm: 1.0
  early_stopping_patience: 3
  save_top_k: 3
  monitor_metric: "val_mAP"

# Optimizer
optimizer:
  type: "adamw"
  lr: 2.0e-4
  weight_decay: 0.01
  betas: [0.9, 0.999]
  eps: 1.0e-8

# Scheduler
scheduler:
  type: "cosine_with_warmup"
  warmup_ratio: 0.1
  min_lr: 1.0e-6
  cosine_cycles: 1

# DataLoader
dataloader:
  num_workers: 16
  prefetch_factor: 3
  pin_memory: true
  persistent_workers: true
  drop_last: true

# 記憶體優化
memory_optimization:
  mixed_precision: true
  amp_dtype: "float16"
  gradient_checkpointing: false
  empty_cache_steps: 100
  log_gpu_memory: true
  alert_vram_threshold_gb: 14.5

# KNN 配置
knn:
  K: 20
  distance_metric: "hamming"
  voting_strategy: "softmax"
  tau: 0.07
  top_n_tags: 5
  inference_batch_size: 64

# 日誌與監控
logging:
  log_every_n_steps: 100
  log_gradients: false
  log_weights: false
  use_wandb: false  # CV 模式關閉 wandb
  wandb_project: "siglip2-5fold-cv"
  wandb_entity: ""
  use_tensorboard: true
  tensorboard_dir: "experiments/tensorboard"

# 檢查點
checkpointing:
  save_dir: "experiments/checkpoints"
  save_every_n_epochs: 10
  save_last: false
  save_top_k: 1
  filename_format: "fold{k_fold.current_fold}_best_mAP{val_mAP:.4f}.pth"

# 資料增強
augmentation:
  use_augmentation: false
  random_flip: false
  color_jitter: false
  random_crop: false